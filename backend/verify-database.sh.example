#!/bin/bash
# Script de verificaci√≥n de base de datos antes de reiniciar el backend
# Este script verifica la conexi√≥n y crea las tablas necesarias

set -e  # Exit on error

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Verificaci√≥n de Base de Datos - Nebula Backend"
echo "================================================="
echo ""

# Database connection string
# IMPORTANTE: Copia este archivo como verify-database.sh y reemplaza con tus credenciales reales
DB_URL="postgresql://YOUR_DB_USER:YOUR_DB_PASSWORD@YOUR_DB_HOST:5432/postgres?sslmode=require"

echo "üì° Paso 1: Verificando conexi√≥n a la base de datos..."
if psql "$DB_URL" -c "SELECT 1;" > /dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ Conexi√≥n exitosa a la base de datos${NC}"
else
    echo -e "${RED}‚ùå No se pudo conectar a la base de datos${NC}"
    echo "   Verifica que la base de datos est√© corriendo"
    exit 1
fi

echo ""
echo "üìã Paso 2: Verificando tablas existentes..."
TABLES=$(psql "$DB_URL" -t -c "SELECT tablename FROM pg_tables WHERE schemaname = 'public';")
echo "   Tablas encontradas:"
if [ -z "$TABLES" ]; then
    echo -e "${YELLOW}   ‚ö†Ô∏è  No hay tablas en la base de datos${NC}"
else
    echo "$TABLES" | sed 's/^/   - /'
fi

echo ""
echo "üèóÔ∏è  Paso 3: Ejecutando script de inicializaci√≥n..."
if psql "$DB_URL" -f "./database/init.sql" > /dev/null 2>&1; then
    echo -e "${GREEN}‚úÖ Script de inicializaci√≥n ejecutado correctamente${NC}"
else
    echo -e "${RED}‚ùå Error al ejecutar script de inicializaci√≥n${NC}"
    exit 1
fi

echo ""
echo "üîç Paso 4: Verificando que todas las tablas se crearon..."
REQUIRED_TABLES=("users" "accounts" "sessions" "verification_tokens" "ml_models")
ALL_GOOD=true

for table in "${REQUIRED_TABLES[@]}"; do
    if psql "$DB_URL" -t -c "SELECT to_regclass('public.$table');" | grep -q "$table"; then
        echo -e "${GREEN}   ‚úÖ Tabla '$table' existe${NC}"
    else
        echo -e "${RED}   ‚ùå Tabla '$table' NO existe${NC}"
        ALL_GOOD=false
    fi
done

echo ""
echo "üìä Paso 5: Verificando √≠ndices..."
INDEXES=$(psql "$DB_URL" -t -c "SELECT indexname FROM pg_indexes WHERE schemaname = 'public';")
INDEX_COUNT=$(echo "$INDEXES" | grep -v '^$' | wc -l)
echo "   √çndices encontrados: $INDEX_COUNT"
echo "$INDEXES" | grep -v '^$' | sed 's/^/   - /'

echo ""
echo "================================================="
if [ "$ALL_GOOD" = true ]; then
    echo -e "${GREEN}‚úÖ TODAS LAS VERIFICACIONES PASARON${NC}"
    echo ""
    echo "La base de datos est√° lista. Puedes reiniciar el backend con:"
    echo ""
    echo -e "${YELLOW}az webapp restart --name YOUR_BACKEND_APP --resource-group YOUR_RESOURCE_GROUP${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}‚ùå ALGUNAS VERIFICACIONES FALLARON${NC}"
    echo ""
    echo "Por favor revisa los errores arriba antes de reiniciar el backend."
    echo ""
    exit 1
fi
