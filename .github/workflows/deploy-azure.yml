name: Deploy to Azure

on:
  push:
    branches:
      - main  # Solo deploy autom√°tico en main
  workflow_dispatch:  # Permite ejecutarlo manualmente desde GitHub

env:
  ACR_REGISTRY: nebulacanadaacr.azurecr.io
  FRONTEND_IMAGE: nebula-image-frontend
  BACKEND_IMAGE: nebula-image-backend
  FRONTEND_APP: NebulaFrontend
  BACKEND_APP: NebulaBackend
  RESOURCE_GROUP: MisRecursos

permissions:
  contents: write  # Permite que el workflow haga commits y push

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del c√≥digo
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para obtener todo el historial de git

      # 2. Configurar Git
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # 3. Actualizar versiones en archivos
      - name: Update version tracking
        id: version
        run: |
          # Obtener el commit SHA corto (primeros 7 caracteres)
          SHORT_SHA=$(git rev-parse --short=7 HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          echo "üìù Actualizando versiones al commit: $SHORT_SHA"

          # Actualizar backend/server/main.py
          sed -i "s/\"git_commit\": \"[a-f0-9]*\"/\"git_commit\": \"$SHORT_SHA\"/" backend/server/main.py

          # Actualizar frontend/components/version-logger.tsx
          sed -i "s/const GIT_COMMIT = \"[a-f0-9]*\"/const GIT_COMMIT = \"$SHORT_SHA\"/" frontend/components/version-logger.tsx

          # Verificar si hubo cambios
          if git diff --quiet; then
            echo "‚úÖ Las versiones ya est√°n actualizadas"
            echo "version_updated=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Versiones actualizadas exitosamente"
            echo "version_updated=true" >> $GITHUB_OUTPUT

            # Mostrar cambios
            echo "üìã Cambios realizados:"
            git diff backend/server/main.py frontend/components/version-logger.tsx
          fi

      # 4. Commit y push de cambios de versi√≥n (si los hay)
      - name: Commit version changes
        if: steps.version.outputs.version_updated == 'true'
        run: |
          git add backend/server/main.py frontend/components/version-logger.tsx
          git commit -m "ü§ñ Auto-update version tracking to ${{ steps.version.outputs.short_sha }}

          Updated by GitHub Actions deployment workflow.

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: GitHub Actions <actions@github.com>"

          # Push usando el token de GitHub
          git push

      # 5. Login a Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 6. Login a Azure Container Registry
      - name: Login to ACR
        run: |
          az acr login --name nebulacanadaacr

      # 7. Build Frontend Image
      - name: Build Frontend Docker Image
        working-directory: ./frontend
        run: |
          echo "üèóÔ∏è Building Frontend..."
          docker build -t ${{ env.FRONTEND_IMAGE }}:latest .
          docker tag ${{ env.FRONTEND_IMAGE }}:latest ${{ env.ACR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ steps.version.outputs.short_sha }}
          docker tag ${{ env.FRONTEND_IMAGE }}:latest ${{ env.ACR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest

      # 8. Build Backend Image
      - name: Build Backend Docker Image
        working-directory: ./backend
        run: |
          echo "üèóÔ∏è Building Backend..."
          docker build -t ${{ env.BACKEND_IMAGE }}:latest .
          docker tag ${{ env.BACKEND_IMAGE }}:latest ${{ env.ACR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ steps.version.outputs.short_sha }}
          docker tag ${{ env.BACKEND_IMAGE }}:latest ${{ env.ACR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest

      # 9. Push Frontend to ACR
      - name: Push Frontend to ACR
        run: |
          echo "‚¨ÜÔ∏è Pushing Frontend images..."
          docker push ${{ env.ACR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ steps.version.outputs.short_sha }}
          docker push ${{ env.ACR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest

      # 10. Push Backend to ACR
      - name: Push Backend to ACR
        run: |
          echo "‚¨ÜÔ∏è Pushing Backend images..."
          docker push ${{ env.ACR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ steps.version.outputs.short_sha }}
          docker push ${{ env.ACR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest

      # 11. Update Frontend Web App
      - name: Update Frontend Web App
        run: |
          echo "üîÑ Updating Frontend Web App..."
          az webapp config container set \
            --name ${{ env.FRONTEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --container-image-name ${{ env.ACR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest

      # 12. Update Backend Web App
      - name: Update Backend Web App
        run: |
          echo "üîÑ Updating Backend Web App..."
          az webapp config container set \
            --name ${{ env.BACKEND_APP }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --container-image-name ${{ env.ACR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest

      # 13. Restart Frontend
      - name: Restart Frontend
        run: |
          echo "üîÑ Restarting Frontend..."
          az webapp restart --name ${{ env.FRONTEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }}

      # 14. Restart Backend
      - name: Restart Backend
        run: |
          echo "üîÑ Restarting Backend..."
          az webapp restart --name ${{ env.BACKEND_APP }} --resource-group ${{ env.RESOURCE_GROUP }}

      # 15. Wait for services to start
      - name: Wait for services
        run: |
          echo "‚è≥ Waiting 60 seconds for services to fully start..."
          sleep 60

      # 16. Verify Backend Deployment
      - name: Verify Backend Deployment
        run: |
          echo "üîç Verifying backend deployment..."
          RESPONSE=$(curl -s https://nebulabackend.azurewebsites.net/health)
          DEPLOYED_COMMIT=$(echo $RESPONSE | jq -r '.git_commit')

          echo "Expected commit: ${{ steps.version.outputs.short_sha }}"
          echo "Deployed commit: $DEPLOYED_COMMIT"

          if [ "$DEPLOYED_COMMIT" == "${{ steps.version.outputs.short_sha }}" ]; then
            echo "‚úÖ Backend deployment verified successfully!"
          else
            echo "‚ö†Ô∏è Warning: Backend may still be starting. Deployed commit doesn't match yet."
            echo "Give it 2-3 more minutes to fully start."
          fi

      # 17. Deployment Summary
      - name: Deployment Summary
        run: |
          echo "================================================"
          echo "‚úÖ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "================================================"
          echo ""
          echo "üåê URLs:"
          echo "  - Frontend: https://nebulafrontend.azurewebsites.net"
          echo "  - Backend:  https://nebulabackend.azurewebsites.net/docs"
          echo "  - Health:   https://nebulabackend.azurewebsites.net/health"
          echo ""
          echo "üì¶ Images deployed:"
          echo "  - Frontend: ${{ env.ACR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ steps.version.outputs.short_sha }}"
          echo "  - Backend:  ${{ env.ACR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ steps.version.outputs.short_sha }}"
          echo ""
          echo "üè∑Ô∏è Version: ${{ steps.version.outputs.short_sha }}"
          echo "üìã Commit: ${{ github.sha }}"
          echo ""
          echo "‚è∞ Services should be fully ready in 2-3 minutes"
          echo "================================================"
